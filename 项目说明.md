# 后端说明 (API & 配置)

## 入口
- 主入口: `app.py` (Flask)  
- 工厂函数: `create_app()` 用于测试和 WSGI 部署
- 支持命令行参数: `--host`, `--port`, `--debug`

## 项目结构
```
server/
  app.py              # 主应用入口，注册所有 blueprint
  settings.py         # 环境变量和配置管理
  config.json         # 价格、充值规则等配置
  requirements.txt    # Python 依赖
  api/                # API blueprint 模块
    pricing.py        # 价格和充值规则 API
    demo.py           # Demo 图片列表 API
    images.py         # 图片相关 API (legacy)
    upload.py         # 文件上传 API
    debug.py          # 调试和健康检查 API
    new_user.py       # 新用户设置 API
  auth/               # 认证模块
    __init__.py       # 认证模块初始化
    session_manager.py # 会话管理器
    session_routes.py  # 会话相关路由（共享）
    session_settings.py # 会话配置（共享）
    state_manager.py  # 状态管理器
    OAuth_认证架构重构.md # OAuth 认证架构重构文档
    google/
      __init__.py     # Google 认证模块初始化
      auth_google.py  # Google OAuth 认证完整实现
    facebook/
      __init__.py     # Facebook 认证模块初始化
      auth_facebook.py # Facebook OAuth 认证实现
  database/           # 数据库相关
    __init__.py       # 数据库模块初始化
    db.py             # 数据库操作函数
    db_init.sql       # 数据库初始化脚本
    init_db.py        # 数据库初始化工具
    readme.md         # 数据库说明
    requirements-postgres.txt # PostgreSQL 依赖
    debug/            # 数据库调试工具
      common.py       # 调试通用函数
      test_conn.py    # 数据库连接测试
      test_user_insert.py # 用户插入测试
    sql/              # SQL 脚本
      insert_identity.sql # 插入身份记录
      insert_user.sql     # 插入用户记录
      select_user_by_email.sql # 通过邮箱查询用户
      select_user_by_provider_sub.sql # 通过提供商 sub 查询用户
      select_user_id_by_email.sql # 通过邮箱查询用户 ID
  services/           # 服务层
    files.py          # 文件列表服务
    storage.py        # 存储服务 (本地/S3)
  tests/              # 测试文件
    test_demo_endpoints.py     # Demo API 测试
    test_upload_and_services.py # 上传服务测试
  upload/             # 本地上传文件存储目录
```

# 后端说明（已迁移）

本仓库现仅包含 Web 前端代码。原有的 Flask 后端及其文档、脚本和配置已经迁移到独立的 **server** 项目中维护。

- 请在新的服务端仓库中查看 API、数据库、Redis、定时任务等说明。
- 本仓库中的 `.env` 仅保留前端需要的 `VITE_` 变量；后端相关环境变量请在服务端项目中配置。
- 开发前端时，如需调用本地或远程后端，可通过 `VITE_API_BASE` 指定 API 根地址，或在 Vite 代理中指向新的服务端实例。

> 若需要定位新的后端仓库地址，请参考团队内部文档或在版本管理平台上搜索 “headshot-ai-server”。
| MAX_USER_SESSIONS | 每用户会话上限 | 10 | 防止无限设备占用资源，0=无限 |
| REDIS_PREFIX | Redis key 前缀 | appauth | 隔离多应用 key 空间 |

前端已加入 `useSessionHeartbeat`（仅在页面可见时每 10 分钟调用 `/api/auth/session`），需确保上述变量配置后即可获得“长时间不访问仍保持登录”的体验。

生产判定: APP_ENV/ENV in {prod, production} => 生产；debug blueprint 不注册。

## 配置文件
- `server/config.json`:
  - price_map / recharge_rules / total_images / per_page 等
- 读取封装：`settings.load_config()` (LRU 缓存一次)

## 详细目录结构说明

### API 层 (api/)
- `pricing.py`: 价格和充值规则API，从 config.json 读取配置
- `demo.py`: Demo图片列表API，包含分页和筛选功能
- `images.py`: 旧版图片API，保持向后兼容
- `upload.py`: 文件上传API
  - 支持本地存储和S3存储
  - 提供文件上传接口 (`/api/upload`)
  - 提供已上传文件列表接口 (`/api/upload/faces/recent`, `/api/upload/faces/all`)
  - 提供文件访问接口 (`/upload/<user>/<category>/<filename>`)
  - 支持多种文件分类（faces、backdrops、outfits、poses、hairstyles）
- `new_user.py`: 新用户初始设置API，返回各个 plan 的默认选项卡片选择数量
- `debug.py`: 开发调试API，包含健康检查和路由列表

### 认证系统 (auth/)
- `session_manager.py`: 统一的会话管理器，支持Redis和内存存储
- `session_routes.py`: 会话相关路由，提供跨提供商的会话管理和注销接口
- `session_settings.py`: 会话配置，包含 cookie 设置、TTL 配置等
- `state_manager.py`: 认证状态管理器，处理OAuth状态验证
- `google/auth_google.py`: 完整的Google OAuth认证实现，包含PKCE流程
- `facebook/auth_facebook.py`: Facebook OAuth认证实现

### 数据库层 (database/)
- `db.py`: 数据库操作函数，封装常用的增删改查
- `init_db.py`: 数据库初始化工具
- `debug/`: 数据库调试工具集
- `sql/`: SQL脚本集合

### 服务层 (services/)
- `files.py`: 文件列表服务，处理分类文件查找
- `storage.py`: 存储服务，统一处理本地和S3存储

## 常用命令
开发自动重载：
```
./run_server
```
指定端口：
```
PORT=5001 ./run_server
```
一次性运行：
```
./run_server once
```
健康检查：
```
curl -s http://127.0.0.1:5010/api/health
```
查看路由 (非生产)：
```
curl -s http://127.0.0.1:5010/api/_routes | jq '.count'
```

## 测试
安装依赖后：
```
pytest server/tests -q
```
生产模式模拟 (不注册 debug)：
```
APP_ENV=prod pytest server/tests -q
```

## 服务层说明
### services/files.py
- `list_files_for_category(category)` 返回指定分类的图片相对路径列表
  - 支持嵌套分类如 'Studio/Dark'
  - 返回格式: `images/demo/home/<category>/<filename>`
- `list_demo_faces(gender, ethnicity, limit)` 返回 demo 人脸图片路径列表
  - 基于性别和种族筛选
  - 返回格式: `/images/demo/faces/<gender>/<ethnicity>/<filename>`

### services/storage.py
- `save_file(data, storage_mode, upload_dir, user_id, category, ext, file_name)`
  - local 模式: 返回 `/upload/...` 路径
  - s3 模式: 返回对象 key (外部自行拼 URL)
- `build_file_name(ext)` 基于毫秒时间戳生成文件名

## 安全及后续建议
- 在生产环境增加 `/api/_routes` 的鉴权（或保持禁用）
- 为上传增加大小 / MIME 检查
- 引入 CI (GitHub Actions) + coverage
- S3 模式可使用 moto 库做单测 mock
- 增加简单速率限制 (Flask-Limiter) 针对写操作

## 认证系统说明

### 认证架构
认证系统采用模块化设计，分为提供商特定模块和共享会话管理：

#### 提供商模块
- `auth/google/auth_google.py`: Google OAuth 认证流程
  - PKCE (Proof Key for Code Exchange) 安全流程
  - 支持弹窗和全页面两种认证模式
  - Safari/iOS 兼容性处理
- `auth/facebook/auth_facebook.py`: Facebook OAuth 认证流程

#### 共享会话管理
- `auth/session_manager.py`: 统一的会话管理器
  - 支持 Redis 或内存存储
  - 滑动续期 (Session Sliding)
  - 多设备会话管理
- `auth/session_routes.py`: 跨提供商的会话路由
  - 会话信息获取（包含最近上传的人脸）
  - 会话列表和管理
  - 多种注销方式
- `auth/session_settings.py`: 会话配置
  - Cookie 设置（名称、安全标志、域名等）
  - TTL 配置（最小会话时间、滑动续期、绝对上限等）

### 主要路由

#### Google 认证路由
- `/api/auth/google/start` - 开始 Google 认证流程
- `/api/auth/google/callback` - Google 认证回调处理

#### 共享会话路由
- `/api/auth/session` - 获取当前会话信息（支持滑动续期，包含最近上传的人脸）
- `/api/auth/sessions` - 列出用户所有会话
- `/api/auth/logout` - 登出当前会话
- `/api/auth/logout_all` - 登出所有会话
- `/api/auth/logout_session` - 登出指定会话

### 环境变量配置

#### Google OAuth 配置
- `GOOGLE_CLIENT_ID` - Google OAuth 客户端 ID
- `GOOGLE_CLIENT_SECRET` - Google OAuth 客户端密钥
- `GOOGLE_REDIRECT_URI` - 重定向 URI

#### 会话配置
- `SESSION_COOKIE_SECURE` - Cookie 安全标志
- `REDIS_URL` - Redis 连接 URL (可选)
- 其他会话相关配置见"会话 & 认证"部分

## 变更历史要点
- 原 monolithic `image_api.py` 已拆分为多个 blueprint + `app.py`
- 添加统一 settings + 健康检查 + 条件调试路由
- 集成完整的 Google OAuth 认证系统，支持PKCE安全流程
- 实现会话管理和滑动续期机制，支持跨提供商共享
- 添加 `session_routes.py` 和 `session_settings.py`，统一会话管理
- 添加 `new_user.py` API，提供新用户初始设置
- 覆盖基础单元测试与上传/服务层测试
- 支持本地存储和S3存储的统一接口
- 添加数据库调试工具集
- 上传 API 支持列出用户已上传的人脸文件

## 架构设计说明
后端采用模块化设计，各个模块职责清晰：

### API 层设计
- 使用 Flask Blueprint 进行模块化
- 统一的错误处理和响应格式
- 支持 CORS 跨域请求
- 条件性加载调试功能（仅开发环境）

### 认证系统设计
- 完整的 Google OAuth 2.0 + PKCE 流程
- 模块化设计：提供商特定模块 + 共享会话管理
- 会话管理支持 Redis 和内存存储
- 滑动续期机制延长用户会话
- 多设备会话管理和安全控制
- 跨提供商的统一会话接口

### 存储系统设计
- 统一的存储接口，支持本地和 S3
- 文件上传预处理（压缩、格式转换）
- 分类存储和用户隔离

### 数据库设计
- PostgreSQL 作为主数据库
- 完整的初始化脚本和调试工具
- 用户身份和会话数据分离存储

---
如需英文版本，可后续添加 `BACKEND_README.en.md`。
