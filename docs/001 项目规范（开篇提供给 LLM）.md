## Headshot AI Server · Conversation Kickoff Guide

本规范适用于 GPT-5 Codex、Claude Sonnet 4.5 等模型在本仓库的所有协作任务。

> 当前仓库仅保留 **后端（Flask 服务端）**，前端已拆分到其他项目。请根据以下规范启动新的对话与协作。

### 1. 项目背景
- 该服务为 Headshot AI 产品的后端，负责：
  - 处理用户认证与会话（Google OAuth + Redis/内存 SessionManager）。
  - 管理素材上传、定价、套餐配置等核心业务 API。
  - 维护金币体系与 Stripe 支付流程（Checkout Session、Webhook、余额更新）。
  - 通过 PostgreSQL 存储用户、金币流水等数据。

### 2. 技术栈与关键依赖
- Python 3 / Flask (Blueprint 架构)。
- PostgreSQL（`database/db.py`，`coin_topups` 等表）。
- Redis 可选，用于会话持久化。
- Stripe 官方 SDK（`stripe`），配套 Webhook。
- Pytest 单测 (`server/tests/`)，覆盖 API、服务层逻辑。

### 3. 开发前必读
1. 阅读根目录 `项目说明.md`，确认工程结构与最新约定。
2. 熟悉 `server/app.py`、`api/`、`auth/`、`database/`、`services/`。理解现有蓝图与会话机制再修改。
3. 若文档与实际代码不符，按实际代码执行，并在任务完成后更新 `项目说明.md`。

### 4. 代码规范
- 保持现有目录结构、命名风格、注释密度，禁止新增版权头。
- API 返回、日志、调试输出一律使用英文；注释使用中文（专业名词保留英文）。
- 修改数据库或外部依赖前，评估迁移脚本与幂等处理。
- Stripe / 金币逻辑涉及金融数据，务必保证幂等、事务安全及异常日志。
- 变更会话或认证代码时，考虑多设备、滑动续期、Redis/内存双模式兼容。

### 5. 工作流程
1. **分析**：先梳理需求、定位相关模块，必要时查阅 `docs/` 说明。
2. **实现**：以最小变更满足需求，避免过度工程；如需大规模重构，先提出方案。
3. **测试**：至少运行 `pytest`（可定向到受影响文件）；说明未能执行测试的原因。
4. **结果**：总结修改点、测试情况、后续建议。除非要求，否则不要提交 git commit/push。

### 6. 行为准则
- 优先采用简单方案；若新增代码超 100 行，请确认无更精简替代。
- 不相关文件如有异常，除非任务涉及，否则忽略（由对应任务处理）。
- 对第三方 API、环境变量、部署步骤保持敏感，及时确认安全性。
- 输出结论前，如有疑问或假设，先在回复中列明并请用户确认。

### 7. 项目语言
- 项目代码使用英文，项目注释和文档使用中文（保留英文技术术语）。
- 项目输出给前端（web 端、原生 app 端）用户可见的字符串（API 返回、日志等），需为英文。

### 8. 对话沟通
- 对话回复使用中文（保留英文技术术语），注意要结构清晰、简练友好；
- 若需要当前对话对象输入或配置（如环境变量），列出清单并解释用途。

### 9. 立即行动提示
请仔细阅读以上说明，并确认是否需要更新 `项目说明.md`。若有差异立即调整，并告知“明白，已经调整说明文档”；如无则回复“明白，已经阅读相关文档。无需调整说明文档”。
